@model SanPham
@{
    ViewData["Title"] = Model.TenSp;
}

<div class="row">
    <div class="col-md-6">
        <div class="card">
            @if (!string.IsNullOrEmpty(Model.HinhAnh))
            {
                <img src="~/images/products/@Model.HinhAnh"
                     alt="@Model.TenSp"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                <div class="fallback-icon" style="display: none;">
                    <i class="fas fa-coffee"></i>
                </div>
            }
            else
            {
                <div class="fallback-icon">
                    <i class="fas fa-coffee"></i>
                </div>
            }
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-primary">@Model.TenSp</h2>
                <p class="text-muted mb-2">
                    <i class="fas fa-tag"></i> @Model.MaDanhMucNavigation?.TenDanhMuc
                </p>
                <p class="text-muted mb-2">
                    <i class="fas fa-building"></i> @Model.MaNccNavigation?.TenNcc
                </p>
                <p class="text-muted mb-3">
                    <i class="fas fa-globe"></i> Xuất xứ: @Model.XuatXu
                </p>

                <div class="border-top pt-3 mb-3">
                    <h3 class="text-success">@Model.Gia.ToString("N0") VNĐ</h3>
                    <p class="text-muted">Đơn vị tính: @Model.DonViTinh</p>
                    <p class="text-success">
                        <i class="fas fa-check-circle"></i> Còn hàng (@Model.SoLuongTon @Model.DonViTinh)
                    </p>
                </div>

                <div class="mb-3">
                    <label class="form-label">Số lượng:</label>
                    <div class="input-group" style="width: 150px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(-1)">-</button>
                        <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="@Model.SoLuongTon">
                        <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(1)">+</button>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="addToCart()">
                        <i class="fas fa-cart-plus"></i> Thêm vào giỏ hàng
                    </button>
                    <a class="btn btn-outline-secondary" asp-action="Index">
                        <i class="fas fa-arrow-left"></i> Quay lại danh sách
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Mô tả sản phẩm</h5>
            </div>
            <div class="card-body">
                <p>@(Model.MoTa ?? "Chưa có mô tả chi tiết cho sản phẩm này.")</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function changeQuantity(delta) {
            const input = document.getElementById('quantity');
            let newValue = parseInt(input.value) + delta;
            if (newValue < 1) newValue = 1;
            if (newValue > @Model.SoLuongTon) newValue = @Model.SoLuongTon;
            input.value = newValue;
        }

        function addToCart() {
        @if (Context.Session.GetString("Username") == null)
        {
            <text>
                    alert('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng!');
                    window.location.href = '@Url.Action("Login", "Account")';
                    return;
            </text>
        }

            const quantity = document.getElementById('quantity').value;
            $.post('@Url.Action("AddToCart", "GioHang")', {
                maSP: '@Model.MaSp',
                soLuong: quantity
            }, function(data) {
                if (data.success) {
                    alert(data.message);
                } else {
                    alert(data.message);
                }
            });
        }
    </script>
}